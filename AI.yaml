// --- 1. é™æ€é…ç½®åŒºåŸŸ ---

const enable = true;

/**
 * åˆ†æµè§„åˆ™é…ç½®ï¼Œè¯·ä¿æŒâ€œæœ€å°ï¼Œå¯ç”¨â€åŸåˆ™
 */
const ruleOptions = {
  apple: true,
  microsoft: true,
  github: true,
  google: true,
  openai: true,
  spotify: true,
  youtube: true,
  bahamut: true,
  netflix: true,
  tiktok: true,
  disney: true,
  pixiv: true,
  hbo: true,
  hulu: true,
  primevideo: true,
  telegram: true,
  line: true,
  whatsapp: true,
  japan: true,
  'social-media': true, // Xç»„
  // å·²åˆ é™¤: games: true, 
};

const skipIps = ['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '169.254.0.0/16', '127.0.0.0/8', 'FC00::/7', 'FE80::/10', '::1/128'];

const rules = [
  'RULE-SET,applications,ä¸‹è½½è½¯ä»¶',
  'PROCESS-NAME,SunloginClient,DIRECT', 'PROCESS-NAME,SunloginClient.exe,DIRECT',
  'PROCESS-NAME,AnyDesk,DIRECT', 'PROCESS-NAME,AnyDesk.exe,DIRECT',
  'PROCESS-NAME,èŠ‚ç‚¹å°å®,DIRECT', 'PROCESS-NAME,nblink.exe,DIRECT',
  'PROCESS-NAME,NodeBabyLinkBackup,DIRECT', 'PROCESS-NAME,NodeBabyLinkClient,DIRECT',
  'PROCESS-NAME,NodeBabyLinkRfile,DIRECT', 'PROCESS-NAME,NodeBabyLinkBackup.exe,DIRECT',
  'PROCESS-NAME,NodeBabyLinkClient.exe,DIRECT', 'PROCESS-NAME,NodeBabyLinkDevice.exe,DIRECT',
  'PROCESS-NAME,NodeBabyLinkOwjdxb.exe,DIRECT', 'PROCESS-NAME,NodeBabyLinkRfile.exe,DIRECT',
  'PROCESS-NAME,NodeBabyLinkService.exe,DIRECT',
  'DOMAIN-SUFFIX,iepose.com,DIRECT', 'DOMAIN-SUFFIX,ionewu.com,DIRECT',
];

// åœ°åŒºå®šä¹‰ (ä¿æŒä¸å˜)
const regionDefinitions = [{
    name: 'HKé¦™æ¸¯',
    regex: /æ¸¯|ğŸ‡­ğŸ‡°|hk|hongkong|hong kong/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Hong_Kong.png'
  },
  {
    name: 'USç¾å›½',
    regex: /(?!.*aus)(?=.*(ç¾|ğŸ‡ºğŸ‡¸|us(?!t)|usa|american|united states)).*/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/United_States.png'
  },
  {
    name: 'JPæ—¥æœ¬',
    regex: /æ—¥æœ¬|ğŸ‡¯ğŸ‡µ|jp|japan/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Japan.png'
  },
  {
    name: 'KRéŸ©å›½',
    regex: /éŸ©|ğŸ‡°ğŸ‡·|kr|korea/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Korea.png'
  },
  {
    name: 'SGæ–°åŠ å¡',
    regex: /æ–°åŠ å¡|ğŸ‡¸ğŸ‡¬|sg|singapore/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Singapore.png'
  },
  {
    name: 'CNä¸­å›½å¤§é™†',
    regex: /ä¸­å›½|ğŸ‡¨ğŸ‡³|cn|china/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/China_Map.png'
  },
  {
    name: 'TWå°æ¹¾çœ',
    regex: /å°æ¹¾|ğŸ‡¹ğŸ‡¼|tw|taiwan|tai wan/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/China.png'
  },
  {
    name: 'GBè‹±å›½',
    regex: /è‹±|ğŸ‡¬ğŸ‡§|uk|united kingdom|great britain/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/United_Kingdom.png'
  },
  {
    name: 'DEå¾·å›½',
    regex: /å¾·å›½|ğŸ‡©ğŸ‡ª|de|germany/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Germany.png'
  },
  {
    name: 'MYé©¬æ¥è¥¿äºš',
    regex: /é©¬æ¥|ğŸ‡²ğŸ‡¾|my|malaysia/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Malaysia.png'
  },
  {
    name: 'TKåœŸè€³å…¶',
    regex: /åœŸè€³å…¶|ğŸ‡¹ğŸ‡·|tk|turkey/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Turkey.png'
  },
  {
    name: 'CAåŠ æ‹¿å¤§',
    regex: /åŠ æ‹¿å¤§|ğŸ‡¨ğŸ‡¦|ca|canada/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Canada.png'
  },
  {
    name: 'AUæ¾³å¤§åˆ©äºš',
    regex: /æ¾³å¤§åˆ©äºš|ğŸ‡¦ğŸ‡º|au|australia|sydney/i,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Australia.png'
  },
];
const excludeHighPercentage = true;
const globalRatioLimit = 2;

// DNS é…ç½® (æé™ä¼˜åŒ–: ç²¾ç®€ Nameserver å’Œç§»é™¤ nameserver-policy)
const chinaDNS = ['119.29.29.29', '223.5.5.5'];
// æé™ä¼˜åŒ–: åªä½¿ç”¨ä¸€ä¸ªé«˜æ€§èƒ½ DoH æœåŠ¡
const foreignDNS = ['https://doh.pub/dns-query'];
const dnsConfig = {
  enable: true,
  listen: ':1053',
  ipv6: true,
  'prefer-h3': true, // æé™ä¼˜åŒ–ï¼šå¯ç”¨ HTTP/3 DOH
  'use-hosts': true,
  'use-system-hosts': true,
  'respect-rules': true,
  'enhanced-mode': 'fake-ip',
  'fake-ip-range': '198.18.0.1/16',
  'fake-ip-filter-mode': 'whitelist',
  'fake-ip-filter': [
    'geosite:cn', 
    'geosite:gfw', 
    'geosite:jetbrains-ai', 
    'geosite:category-ai-!cn', 
    'geosite:category-ai-chat-!cn', 
    // å·²åˆ é™¤: 'geosite:category-games-!cn', 
    'geosite:google@!cn', 
    'geosite:telegram', 
    'geosite:facebook', 
    'geosite:google', 
    'geosite:amazon', 
    'geosite:category-bank-jp', 
    'geosite:category-bank-cn@!cn'
  ],
  nameserver: foreignDNS,
  fallback: [], 
  'fallback-filter': {
    geoip: false,
  },
  'proxy-server-nameserver': foreignDNS,
  // æé™ä¼˜åŒ–ï¼šç§»é™¤ nameserver-policyï¼Œä¾èµ– fake-ip æœºåˆ¶
  'nameserver-policy': {}, 
};

const ruleProviderCommon = {
  type: 'http',
  format: 'yaml',
  interval: 86400
};

// ç­–ç•¥ç»„ä¼˜åŒ–å‚æ•° (ä¿æŒä¸å˜)
const groupBaseOption = {
  interval: 180,
  timeout: 2000,
  url: 'http://cp.cloudflare.com/generate_204',
  lazy: true,
  'max-failed-times': 2,
  hidden: false,
};

const ruleProviders = {
  applications: {
    ...ruleProviderCommon,
    behavior: 'classical',
    format: 'text',
    url: 'https://github.com/DustinWin/ruleset_geodata/raw/refs/heads/mihomo-ruleset/applications.list',
    path: './ruleset/DustinWin/applications.list',
  }
};

const multiplierRegex = /(?<=[xXâœ•âœ–â¨‰å€ç‡])([1-9]+(\.\d+)*|0{1}\.\d+)(?=[xXâœ•âœ–â¨‰å€ç‡])*/i;

// --- 2. æœåŠ¡è§„åˆ™æ•°æ®ç»“æ„ (å·²åº”ç”¨æ‰€æœ‰ä¿®æ”¹) ---
const serviceConfigs = [
  // ğŸ¯ å·²åˆ é™¤: ä»»ä½• key ä¸º 'games' çš„é…ç½®é¡¹ã€‚
  {
    key: 'openai',
    name: 'å›½å¤–AI',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/ChatGPT.png',
    url: 'https://chat.openai.com/cdn-cgi/trace',
    rules: ['GEOSITE,jetbrains-ai,å›½å¤–AI', 'GEOSITE,category-ai-!cn,å›½å¤–AI', 'GEOSITE,category-ai-chat-!cn,å›½å¤–AI', 'DOMAIN-SUFFIX,meta.ai,å›½å¤–AI', 'DOMAIN-SUFFIX,meta.com,å›½å¤–AI', 'DOMAIN-SUFFIX,gemini.google.com,å›½å¤–AI'] 
  },
  {
    key: 'youtube',
    name: 'YouTube',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/YouTube.png',
    url: 'https://www.youtube.com/s/desktop/494dd881/img/favicon.ico',
    rules: ['GEOSITE,youtube,YouTube']
  },
  {
    key: 'bahamut',
    name: 'å·´å“ˆå§†ç‰¹',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Bahamut.png',
    url: 'https://ani.gamer.com.tw/ajax/getdeviceid.php',
    rules: ['GEOSITE,bahamut,å·´å“ˆå§†ç‰¹']
  },
  {
    key: 'disney',
    name: 'Disney+',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Disney+.png',
    url: 'https://disney.api.edge.bamgrid.com/devices',
    rules: ['GEOSITE,disney,Disney+']
  },
  {
    key: 'netflix',
    name: 'NETFLIX',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Netflix.png',
    url: 'https://api.fast.com/netflix/speedtest/v2?https=true',
    rules: ['GEOSITE,netflix,NETFLIX']
  },
  {
    key: 'tiktok',
    name: 'Tiktok',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/TikTok.png',
    url: 'https://www.tiktok.com/',
    rules: ['GEOSITE,tiktok,Tiktok']
  },
  {
    key: 'spotify',
    name: 'Spotify',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Spotify.png',
    url: 'http://spclient.wg.spotify.com/signup/public/v1/account',
    rules: ['GEOSITE,spotify,Spotify']
  },
  {
    key: 'pixiv',
    name: 'Pixiv',
    icon: 'https://play-lh.googleusercontent.com/8pFuLOHF62ADcN0ISUAyEueA5G8IF49mX_6Az6pQNtokNVHxIVbS1L2NM62H-k02rLM=w240-h480-rw',
    url: 'http://spclient.wg.spotify.com/signup/public/v1/account',
    rules: ['GEOSITE,pixiv,Pixiv']
  },
  {
    key: 'hbo',
    name: 'HBO',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/HBO.png',
    url: 'https://www.hbo.com/favicon.ico',
    rules: ['GEOSITE,hbo,HBO']
  },
  {
    key: 'primevideo',
    name: 'Prime Video',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Prime_Video.png',
    url: 'https://m.media-amazon.com/images/G/01/digital/video/web/logo-min-remaster.png',
    rules: ['GEOSITE,primevideo,Prime Video']
  },
  {
    key: 'hulu',
    name: 'Hulu',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Hulu.png',
    url: 'https://auth.hulu.com/v4/web/password/authenticate',
    rules: ['GEOSITE,hulu,Hulu']
  },
  {
    key: 'telegram',
    name: 'Telegram',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Telegram.png',
    url: 'http://www.telegram.org/img/website_icon.svg',
    rules: ['GEOIP,telegram,Telegram']
  },
  {
    key: 'whatsapp',
    name: 'WhatsApp',
    icon: 'https://static.whatsapp.net/rsrc.php/v3/yP/r/rYZqPCBaG70.png',
    url: 'https://web.whatsapp.com/data/manifest.json',
    rules: ['GEOSITE,whatsapp,WhatsApp']
  },
  {
    key: 'line',
    name: 'Line',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Line.png',
    url: 'https://line.me/page-data/app-data.json',
    rules: ['GEOSITE,line,Line']
  },
  {
    key: 'apple',
    name: 'è‹¹æœæœåŠ¡',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Apple_2.png',
    url: 'http://www.apple.com/library/test/success.html',
    rules: ['GEOSITE,apple-cn,è‹¹æœæœåŠ¡']
  },
  {
    key: 'google',
    name: 'è°·æ­ŒæœåŠ¡',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Google_Search.png',
    url: 'http://www.google.com/generate_204',
    rules: ['GEOSITE,google,è°·æ­ŒæœåŠ¡']
  },
  {
    key: 'github',
    name: 'Github',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/GitHub.png',
    url: 'https://github.com/robots.txt',
    rules: ['GEOSITE,github,Github']
  },
  {
    key: 'microsoft',
    name: 'å¾®è½¯æœåŠ¡',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Microsoft.png',
    url: 'http://www.msftconnecttest.com/connecttest.txt',
    rules: ['GEOSITE,microsoft@cn,å›½å†…ç½‘ç«™', 'GEOSITE,microsoft,å¾®è½¯æœåŠ¡']
  },
  {
    key: 'japan',
    name: 'æ—¥æœ¬ç½‘ç«™',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/JP.png',
    url: 'https://r.r10s.jp/com/img/home/logo/touch.png',
    rules: ['RULE-SET,category-bank-jp,æ—¥æœ¬ç½‘ç«™', 'GEOIP,jp,æ—¥æœ¬ç½‘ç«™,no-resolve'],
    provider: {
      key: 'category-bank-jp',
      url: 'https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/category-bank-jp.mrs',
      path: './ruleset/MetaCubeX/category-bank-jp.mrs',
      format: 'mrs',
      behavior: 'domain'
    }
  },
  // X ç­–ç•¥ç»„é…ç½®
  {
    key: 'social-media',
    name: 'X',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/bilibili_3.png',
    url: 'https://api.twitter.com/oauth2/token',
    rules: [
      'DOMAIN-SUFFIX,x.com,X', 
      'DOMAIN-SUFFIX,twitter.com,X', 
      'GEOSITE,instagram,X',
      'GEOSITE,facebook,X',
      'DOMAIN-SUFFIX,hanime1.me,X',
      'DOMAIN-SUFFIX,hls-vod.hanime1.me,X',
      'DOMAIN-SUFFIX,cn.pornhub.com,X' 
    ]
  }
];

// --- 3. ä¸»å…¥å£ ---

function main(config) {
  if (!enable) return config;

  const proxies = config?.proxies || [];
  const proxyCount = proxies.length;
  const proxyProviderCount = typeof config?.['proxy-providers'] === 'object' ? Object.keys(config['proxy-providers']).length : 0;

  if (proxyCount === 0 && proxyProviderCount === 0) {
    throw new Error('é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ä»£ç†');
  }

  // 3.1 è¦†ç›–åŸºç¡€é…ç½® (æé™ä¼˜åŒ–)
  config['allow-lan'] = true;
  config['bind-address'] = '*';
  config['mode'] = 'rule';
  config['dns'] = dnsConfig;
  config['profile'] = {
    'store-selected': true,
    'store-fake-ip': true
  };
  config['unified-delay'] = true;
  config['tcp-concurrent'] = true;
  config['keep-alive-interval'] = 1800;
  config['find-process-mode'] = 'strict';
  config['geodata-mode'] = true;
  config['geodata-loader'] = 'memconservative';
  config['geo-auto-update'] = true;
  config['geo-update-interval'] = 24;
  
  // æé™ä¼˜åŒ–: å¯ç”¨ TCP Fast Open å’Œ BBR æ‹¥å¡æ§åˆ¶
  config['tcp-fast-open'] = true;
  config['tcp-congestion'] = 'bbr';
  // æé™ä¼˜åŒ–: æé«˜æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
  config['tcp-max-open-requests'] = 1024; 

  config['sniffer'] = {
    enable: true,
    'force-dns-mapping': true, // å¯ç”¨å¼ºåˆ¶ DNS æ˜ å°„
    'parse-pure-ip': false,
    'override-destination': true,
    sniff: {
      TLS: {
        ports: [443, 8443]
      },
      HTTP: {
        ports: [80, '8080-8880']
      },
      QUIC: {
        ports: [443, 8443]
      }
    },
    'skip-src-address': skipIps,
    'skip-dst-address': skipIps,
    // æé™ä¼˜åŒ–: ç²¾ç®€ force-domain åˆ—è¡¨
    'force-domain': ['+.google.com', '+.youtube.com'],
    'skip-domain': ['Mijia Cloud', '+.oray.com'],
  };

  config['ntp'] = {
    enable: true,
    'write-to-system': false,
    server: 'cn.ntp.org.cn'
  };
  config['tun'] = {
    stack: 'mixed',
    'exclude-interface': ['NodeBabyLink'],
    'route-exclude-address': skipIps,
  };
  config['geox-url'] = {
    geoip: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat',
    geosite: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat',
    mmdb: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb',
    asn: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/GeoLite2-ASN.mmdb',
  };

  config.proxies.push({
    name: 'ç›´è¿',
    type: 'direct',
    udp: true
  });
  
  // 3.2 é«˜æ•ˆä»£ç†åˆ†ç±»
  const regionGroups = {};
  regionDefinitions.forEach(r => regionGroups[r.name] = {
    ...r,
    proxies: []
  });
  const otherProxies = [];

  for (let i = 0; i < proxyCount; i++) {
    const proxy = proxies[i];
    const name = proxy.name;
    let matched = false;

    if (excludeHighPercentage) {
      const match = multiplierRegex.exec(name);
      if (match && parseFloat(match[1]) > globalRatioLimit) {
        continue;
      }
    }

    for (const region of regionDefinitions) {
      if (region.regex.test(name)) {
        regionGroups[region.name].proxies.push(name);
        matched = true;
        break;
      }
    }

    if (!matched) {
      otherProxies.push(name);
    }
  }

  const generatedRegionGroups = [];
  regionDefinitions.forEach(r => {
    const groupData = regionGroups[r.name];
    if (groupData.proxies.length > 0) {
      generatedRegionGroups.push({
        ...groupBaseOption,
        name: r.name,
        // åŒºåŸŸç»„ä½¿ç”¨ fallback (ä¼˜é€‰åŒºåŸŸå†…æœ€å¿«èŠ‚ç‚¹)
        type: 'fallback', 
        tolerance: 20,
        icon: r.icon,
        proxies: groupData.proxies
      });
    }
  });

  const regionGroupNames = generatedRegionGroups.map(g => g.name);

  if (otherProxies.length > 0) {
    generatedRegionGroups.push({
      ...groupBaseOption,
      name: 'å…¶ä»–èŠ‚ç‚¹',
      // ä¿æŒ select ä»¥ä¾¿æ‰‹åŠ¨æ£€æŸ¥éåŒºåŸŸèŠ‚ç‚¹
      type: 'select', 
      proxies: otherProxies,
      icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/World_Map.png',
    });
  }

  // å®šä¹‰å¸¸ç”¨å·¥å…·ä»£ç†ç»„ 
  const downloadGroup = {
    ...groupBaseOption,
    name: 'ä¸‹è½½è½¯ä»¶',
    type: 'select', 
    proxies: ['ç›´è¿', 'REJECT', 'è‡ªåŠ¨ä¼˜é€‰', 'å›½å†…ç½‘ç«™', ...regionGroupNames], 
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Download.png',
  };
  const cnGroup = {
    ...groupBaseOption,
    name: 'å›½å†…ç½‘ç«™',
    type: 'select', 
    proxies: ['ç›´è¿', 'è‡ªåŠ¨ä¼˜é€‰', ...regionGroupNames], 
    url: 'http://wifi.vivo.com.cn/generate_204',
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/StreamingCN.png',
  };

  const manualSelectGroup = {
    ...groupBaseOption,
    name: 'æ‰‹åŠ¨é€‰æ‹©',
    type: 'select', 
    proxies: ['è‡ªåŠ¨ä¼˜é€‰', 'ç›´è¿', ...regionGroupNames, 'å…¶ä»–èŠ‚ç‚¹'].filter(n => n !== 'å…¶ä»–èŠ‚ç‚¹' || otherProxies.length > 0),
    icon: 'https://raw.githubusercontent.com/Lanlan13-14/Icon-for-webui/main/fallback.png', 
  };

  // 3.3 æ„å»ºåŠŸèƒ½ç­–ç•¥ç»„ - é‡æ–°æ’åºé€»è¾‘
  const functionalGroups = [];
  
  // 1. è‡ªåŠ¨ä¼˜é€‰èŠ‚ç‚¹
  const autoTestGroup = {
    ...groupBaseOption,
    name: 'è‡ªåŠ¨ä¼˜é€‰', 
    type: 'url-test', 
    proxies: [...regionGroupNames, 'å…¶ä»–èŠ‚ç‚¹'].filter(n => n !== 'å…¶ä»–èŠ‚ç‚¹' || otherProxies.length > 0),
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Proxy.png',
  };

  // Helper function to process a service config
  const processService = (svc) => {
    // Process rules and rule providers
    if (ruleOptions[svc.key]) {
        rules.push(...svc.rules);
        if (svc.provider) {
          ruleProviders[svc.provider.key] = {
            ...ruleProviderCommon,
            behavior: svc.provider.behavior,
            format: svc.provider.format,
            url: svc.provider.url,
            path: svc.provider.path
          };
        }
    }
    
    // Set proxy order 
    let groupProxies;
    if (svc.key === 'bahamut') {
      // å·´å“ˆå§†ç‰¹è§„åˆ™ï¼Œç›´è¿åœ¨å‰ï¼Œæ–¹ä¾¿å°æ¹¾ç”¨æˆ·
      groupProxies = ['è‡ªåŠ¨ä¼˜é€‰', 'ç›´è¿', ...regionGroupNames];
    } else {
      // å…¶ä»–æœåŠ¡ï¼Œè‡ªåŠ¨ä¼˜é€‰åœ¨å‰
      groupProxies = ['è‡ªåŠ¨ä¼˜é€‰', ...regionGroupNames, 'ç›´è¿'];
    }

    return {
      ...groupBaseOption,
      name: svc.name,
      // ä¿æŒ select ç­–ç•¥ï¼Œå…è®¸æ‰‹åŠ¨é€‰æ‹©
      type: 'select', 
      proxies: groupProxies,
      url: svc.url,
      icon: svc.icon,
      key: svc.key // Temporary key for sorting
    };
  };

  // 2. å°†æ‰€æœ‰å¯ç”¨æœåŠ¡ç»„åˆ†ç±»
  const allServiceGroups = serviceConfigs.filter(svc => ruleOptions[svc.key]).map(processService);
  const orderedServiceGroups = [];
  
  // æå–å¹¶æ’åºå‰ 4 ä¸ªç›®æ ‡æœåŠ¡ç»„ (X, YT, AI, Google)
  const mainOrderedServiceKeys = ['social-media', 'youtube', 'openai', 'google'];
  mainOrderedServiceKeys.forEach(key => {
    const group = allServiceGroups.find(g => g.key === key);
    if (group) {
      orderedServiceGroups.push(group);
    }
  });
  
  // æå–å‰©ä½™çš„æœåŠ¡ç»„ (æ’é™¤å‰ 4 ä¸ª)
  const excludedKeys = [...mainOrderedServiceKeys];
  const remainingServiceGroups = allServiceGroups.filter(g => !excludedKeys.includes(g.key));

  // 3. ç»„è£…æœ€ç»ˆ functionalGroups åˆ—è¡¨ (æŒ‰è¦æ±‚æ’åº)
  
  // 1. æ‰‹åŠ¨é€‰æ‹©
  functionalGroups.push(manualSelectGroup); 
  // 2. è‡ªåŠ¨ä¼˜é€‰ 
  functionalGroups.push(autoTestGroup); 

  // ç§»é™¤ä¸´æ—¶ key å±æ€§
  allServiceGroups.forEach(g => delete g.key); 

  functionalGroups.push(
    ...orderedServiceGroups, // 3-6. X, YouTube, å›½å¤–AI, è°·æ­ŒæœåŠ¡
    downloadGroup,          // 7. ä¸‹è½½è½¯ä»¶
    cnGroup,                // 8. å›½å†…ç½‘ç«™
    // å·²åˆ é™¤: æ¸¸æˆä¸“ç”¨ group (æ­¤å¤„ä¸å†æœ‰é€»è¾‘)
  );
  
  // 9. å…¶ä»–å‰©ä½™æœåŠ¡ç»„ (å·´å“ˆå§†ç‰¹ã€NETFLIXã€Disney+ ç­‰)
  functionalGroups.push(
    ...remainingServiceGroups, 
  );

  // 3.4 æ·»åŠ é€šç”¨å…œåº•ç­–ç•¥ç»„ (è§„åˆ™)
  rules.push(
    'GEOSITE,private,DIRECT',
    'GEOIP,private,DIRECT,no-resolve',
    'GEOSITE,cn,å›½å†…ç½‘ç«™', // ä¸­å›½å¤§é™†åŸŸåæµé‡å¯¼å‘ å›½å†…ç½‘ç«™ ç­–ç•¥ç»„ (é»˜è®¤ç›´è¿)
    'GEOIP,cn,å›½å†…ç½‘ç«™,no-resolve', // ä¸­å›½å¤§é™† IP æµé‡å¯¼å‘ å›½å†…ç½‘ç«™ ç­–ç•¥ç»„ (é»˜è®¤ç›´è¿)
    'MATCH,æ‰‹åŠ¨é€‰æ‹©' // æœ€ç»ˆå…œåº•è§„åˆ™å¯¼å‘ æ‰‹åŠ¨é€‰æ‹© ç­–ç•¥ç»„
  );

  // 3.5 ç»„è£…æœ€ç»ˆç»“æœ (ä¿æŒä¸å˜)
  config['proxy-groups'] = [
    ...functionalGroups,
    ...generatedRegionGroups
  ];

  config['rules'] = rules;
  config['rule-providers'] = ruleProviders;

  return config;
}
// --- 1. DNS 极速解析 (精简为最稳定的主流 DOH) ---
const domesticNameservers = [
  "https://223.5.5.5/dns-query", // 阿里
  "https://120.53.53.53/dns-query" // 腾讯
];

const foreignNameservers = [
  "https://1.1.1.1/dns-query",
  "https://dns.google/dns-query"
];

function main(config) {
  if (!config || !config.proxies) return config;

  // --- 2. 基础性能参数优化 (做减法，保稳定) ---
  config["dns"] = {
    "enable": true,
    "enhanced-mode": "fake-ip",
    "fake-ip-range": "198.18.0.1/16",
    "ipv6": false,
    "prefer-h3": false,
    "cache-algorithm": "laru", // 使用最近最少使用算法缓存 DNS
    "default-nameserver": ["223.5.5.5", "119.29.29.29"],
    "nameserver": domesticNameservers,
    "fallback": foreignNameservers,
    "nameserver-policy": {
      "geosite:cn": domesticNameservers,
      "geosite:google,youtube,telegram,github": foreignNameservers
    }
  };

  // --- 3. 流量处理与连接优化 ---
  config["sniffer"] = {
    "enable": true, // 开启嗅探，确保分流更准确，减少误走代理
    "sniff": {
      "TLS": { "ports": [443, 8443] },
      "HTTP": { "ports": [80, "8080-8880"], "override-destination": true }
    }
  };

  // 关闭实验性并发，减少 CPU 占用和连接错误
  config["tcp-concurrent"] = false; 
  config["profile"] = { "store-selected": true, "store-fake-ip": true };

  // --- 4. 规则集配置 ---
  const ruleProviderCommon = { "type": "http", "format": "yaml", "interval": 86400, "lazy": true };
  config["rule-providers"] = {
    "bilibili": { ...ruleProviderCommon, "behavior": "classical", "url": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/rule/BilibiliHMT.txt", "path": "./ruleset/bilibili.yaml" },
    "bahamut": { ...ruleProviderCommon, "behavior": "classical", "url": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/rule/Bahamut.txt", "path": "./ruleset/bahamut.yaml" },
    "ai": { ...ruleProviderCommon, "behavior": "classical", "url": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/rule/AI.txt", "path": "./ruleset/ai.yaml" },
    "youtube": { ...ruleProviderCommon, "behavior": "classical", "url": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/rule/YouTube.txt", "path": "./ruleset/youtube.yaml" },
    "google": { ...ruleProviderCommon, "behavior": "domain", "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt", "path": "./ruleset/google.yaml" },
    "telegram": { ...ruleProviderCommon, "behavior": "ipcidr", "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt", "path": "./ruleset/telegram.yaml" },
    "cn_ip": { ...ruleProviderCommon, "behavior": "ipcidr", "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt", "path": "./ruleset/cn_ip.yaml" }
  };

  // --- 5. 路由规则 ---
  config["rules"] = [
    "DOMAIN-SUFFIX,x.com,H",
    "DOMAIN-SUFFIX,instagram.com,H",
    "DOMAIN-SUFFIX,facebook.com,H",
    "DOMAIN-SUFFIX,hanime1.me,H",
    "RULE-SET,ai,AI",
    "RULE-SET,youtube,YouTube",
    "RULE-SET,bilibili,哔哩哔哩",
    "RULE-SET,bahamut,动画疯",
    "RULE-SET,google,谷歌服务",
    "RULE-SET,telegram,电报消息,no-resolve",
    "GEOSITE,CN,全局直连",
    "RULE-SET,cn_ip,全局直连,no-resolve",
    "MATCH,漏网之鱼"
  ];

  // --- 6. 代理组配置 (保留图标) ---
  const groupBase = { "type": "select", "interval": 300, "timeout": 2000, "url": "http://www.gstatic.com/generate_204", "lazy": true };
  
  config["proxy-groups"] = [
    { ...groupBase, "name": "节点选择", "type": "url-test", "tolerance": 50, "include-all": true, "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg" },
    { ...groupBase, "name": "YouTube", "proxies": ["节点选择", "全局直连"], "include-all": true, "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/youtube.svg" },
    { ...groupBase, "name": "动画疯", "proxies": ["节点选择"], "include-all": true, "filter": "(?i)台|tw|港|hk", "icon": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/icon/Bahamut.svg" },
    { ...groupBase, "name": "哔哩哔哩", "proxies": ["全局直连", "节点选择"], "include-all": true, "filter": "(?i)港|hk|台|tw", "icon": "https://raw.githubusercontent.com/Lanlan13-14/Icon-for-webui/main/bilibili.png" },
    { ...groupBase, "name": "H", "proxies": ["节点选择", "全局直连"], "include-all": true, "icon": "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/bilibili_3.png" },
    { ...groupBase, "name": "AI", "proxies": ["节点选择"], "include-all": true, "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/chatgpt.svg" },
    { ...groupBase, "name": "电报消息", "proxies": ["节点选择", "全局直连"], "include-all": true, "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/telegram.svg" },
    { ...groupBase, "name": "谷歌服务", "proxies": ["节点选择", "全局直连"], "include-all": true, "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/google.svg" },
    { ...groupBase, "name": "全局直连", "proxies": ["DIRECT", "节点选择"], "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/link.svg" },
    { ...groupBase, "name": "漏网之鱼", "proxies": ["节点选择", "全局直连"], "include-all": true, "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/fish.svg" }
  ];

  // --- 7. 底层 TCP 优化 ---
  if (Array.isArray(config.proxies)) {
    config.proxies.forEach(p => {
      p.udp = true; 
      p.tfo = true; // 仅保留 TCP Fast Open，这是提速最稳的参数
    });
  }

  return config;
}